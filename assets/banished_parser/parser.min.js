const{TesseractWorker:TesseractWorker}=Tesseract,UPSCALE=2,BASESCALE=1.33,LETTERS="earlypingltumELSAW",NUMERALS="0123456789",SCREENSHOTREGEX="^Screenshotd+.jpg$",RESOURCENAMES="LOG,STONE,IRON,FIREWOOD,COAL,TOOL,FOOD,LEATHER,WOOL,HERB,COAT,ALE",LOADINGMESSAGES=["Reticulating splines...","Cultivating mass...","Accessing optimal threshold...","Binarizing optical samples...","Computing median blur density...","Finding k-means classifier...","Parameterizing features...","Generating glyph signatures...","Calculating Levenshtein distances...","Pre-Processing image data..."];var loadingTextTimer,ocr,records=[],currentFile=0,parsing=!1;const IMGSRC=document.getElementById("imageSrc"),IMGOUT=document.getElementById("imageOut"),INPUT=document.getElementById("fileInput"),DOWNLOADS=document.getElementById("downloads"),BUTTON=document.getElementById("submitButton"),DOWNLOADBUTTON=document.getElementById("downloadButton"),LOADING=document.getElementById("loading"),LOADINGTEXT=document.getElementById("loadingText"),BODY=document.body,ACCORDIONBUTTONS=document.getElementsByClassName("accordion");for(var i=0;i<ACCORDIONBUTTONS.length;i++)ACCORDIONBUTTONS[i].onclick=function(){this.classList.toggle("active");var e=this.nextElementSibling;"block"===e.style.display?e.style.display="none":e.style.display="block"};function loadingTextPick(){LOADINGTEXT.textContent=LOADINGMESSAGES[Math.floor(Math.random()*LOADINGMESSAGES.length)]}function end(){BODY.style.cursor="default",LOADING.hidden=!0,clearInterval(loadingTextTimer),DOWNLOADS.hidden=!1,DOWNLOADBUTTON.hidden=!1,ocr.terminate(),records.forEach(e=>download(JSON.stringify(e),e.Filename+"_"+e.Time,"text/plain"))}function downloadAll(){for(var e=DOWNLOADS.children,t=0;t<e.length;t++)e[t].click(),DOWNLOADS.removeChild(e[t])}function next(){currentFile<INPUT.files.length?(0!=currentFile&currentFile%3==0&&(ocr.terminate(),ocr=new TesseractWorker),IMGSRC.src=URL.createObjectURL(INPUT.files.item(currentFile))):end()}function load(e){processScreenshot(IMGSRC);var t=parameters(UPSCALE*BASESCALE),n={},r={};for(let[e,r]of Object.entries(t.Basic))n[e]=ocr.recognize(IMGOUT,"eng",r);for(let[e,n]of Object.entries(t.Resources))r[e]=ocr.recognize(IMGOUT,"eng",n);Promise.all(Object.values(n).concat(Object.values(r))).then(function(t){for(let[e,t]of Object.entries(n))n[e]=t._resolve.text;for(let[e,t]of Object.entries(r))r[e]=t._resolve.text;getRecord(e,n,r)})}function getRecord(e,t,n){var r=new BanishedRecord;return r.Filename=e.name.replace(".jpg",""),r.Time=new Date(e.lastModified).toISOString(),r.Season=getSeason(t.Season),r.Year=getYear(t.Year),r.Population=getPopulation(t.Population),r.Resources=getResources(n),console.log(r),records.push(r),next(),r}BUTTON.onclick=function(){INPUT.files.length>0?(ocr=new TesseractWorker,next(),BODY.style.cursor="wait",LOADING.hidden=!1,loadingTextTimer=setInterval(loadingTextPick,6e3),loadingTextPick(),BUTTON.toggleAttribute("disabled",!0)):alert("Must submit at least 1 screenshot!")},INPUT.onchange=function(){if(BUTTON.toggleAttribute("disabled",!1),DOWNLOADBUTTON.hidden=!0,DOWNLOADS.hidden=!0,DOWNLOADS.hasChildNodes())for(var e=DOWNLOADS.children,t=0;t<e.length;t++)DOWNLOADS.removeChild(e[t])},IMGSRC.onload=function(){load(INPUT.files.item(currentFile)),currentFile+=1},DOWNLOADBUTTON.onclick=function(){downloadAll()};class BanishedRecord{constructor(e,t,n,r,i,o){this.Filename=e,this.Time=t,this.Season=n,this.Year=r,this.Population=i,this.Resources=o}}function getPopulation(e){var t=[];return e.trim().split("/").forEach(e=>t.push(Number.parseInt(e))),{Adults:t[0],Students:t[1],Children:t[2],Total:t[0]+t[1]+t[2]}}function getSeason(e){return e=e.trim(),"Early Spring,Spring,Late Spring,Early Summer,Summer,Late Summer,Early Autumn,Autumn,Late Autumn,Early Winter,Winter,Late Winter".split(",").reduce((t,n)=>levenshteinDistance(e,t)<levenshteinDistance(e,n)?t:n)}function getYear(e){return Number.parseInt(e.trim())}function getResources(e){var t={};for(let[n,r]of Object.entries(e)){let e=r.trim();t[n]=Number.parseInt(e)}return t}function processScreenshot(e){let t=cv.imread(e),n=new cv.Mat,r=new cv.Size(BASEREGION.width*UPSCALE*BASESCALE,BASEREGION.height*UPSCALE*BASESCALE);cv.cvtColor(t,t,cv.COLOR_RGBA2GRAY,0),t=t.roi(scaleRect(new cv.Rect(0,0,300,170),BASESCALE)),cv.resize(t,t,r,0,0,cv.INTER_AREA),cv.bilateralFilter(t,n,11,12,12,cv.BORDER_DEFAULT),t.delete(),cv.threshold(n,n,122,255,cv.THRESH_BINARY),cv.bitwise_not(n,n),cv.medianBlur(n,n,3),cv.imshow("imageOut",n),n.delete()}function generateParameters(e,t){return{tessedit_char_whitelist:e,tessjs_image_rectangle_left:t.x,tessjs_image_rectangle_top:t.y,tessjs_image_rectangle_width:t.width,tessjs_image_rectangle_height:t.height}}function download(e,t,n){var r=document.createElement("a"),i=new Blob([e],{type:n});r.href=URL.createObjectURL(i),r.download=t+".json",r.innerHTML=t,DOWNLOADS.appendChild(r),DOWNLOADS.appendChild(document.createElement("br"))}function Rect(e,t,n,r){return{x:e,y:t,width:n,height:r}}function scaleRect(e,t){return new Rect(Math.round(e.x*t),Math.round(e.y*t),Math.round(e.width*t),Math.round(e.height*t))}function parameters(e){var t={Season:generateParameters(LETTERS,scaleRect(BASICREGIONS.Season,e)),Year:generateParameters(NUMERALS,scaleRect(BASICREGIONS.Year,e)),Population:generateParameters(NUMERALS.concat("/"),scaleRect(BASICREGIONS.Population,e))},n={};for(let[t,r]of Object.entries(RESOURCEREGIONS))n[t]=generateParameters(NUMERALS,scaleRect(r,e));return{Basic:t,Resources:n}}const BASEREGION=new Rect(0,0,300,170),BASICREGIONS={Season:new Rect(10,38,96,16),Year:new Rect(132,38,16,16),Population:new Rect(218,38,72,16)},RESOURCEREGIONS={Log:new Rect(37,59,64,16),Stone:new Rect(132,59,64,16),Iron:new Rect(229,59,64,16),Firewood:new Rect(37,80,64,16),Coal:new Rect(132,80,64,16),Tool:new Rect(229,80,64,16),Food:new Rect(37,101,64,16),Herb:new Rect(132,101,64,16),Coat:new Rect(229,101,64,16),Ale:new Rect(37,122,64,16),Leather:new Rect(132,122,64,16)};function levenshteinDistance(e,t){var n=e.length,r=t.length,o=createArray(n+1,r+1);if(0==n)return r;if(0==r)return n;for(i=0;i<=n;o[i][0]=i++);for(j=0;j<=r;o[0][j]=j++);for(i=1;i<=n;i++)for(j=1;j<=r;j++){let n=t[j-1]==e[i-1]?0:1;o[i][j]=Math.min(Math.min(o[i-1][j]+1,o[i][j-1]+1),o[i-1][j-1]+n)}return o[n][r]}function createArray(e){var t=new Array(e||0),n=e;if(arguments.length>1)for(var r=Array.prototype.slice.call(arguments,1);n--;)t[e-1-n]=createArray.apply(this,r);return t}function extend(e,t){return Object.keys(t).forEach(function(n){e[n]=t[n]}),e}